<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Product List</title>
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css">
    <!-- datatable with bootstrap -->

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- bootstrap -->

    <script src="https://code.jquery.com/jquery-3.7.1.js"></script> <!-- jQuery -->
</head>

<body>
    <div class="container">
        <h2 class="mb-4">Product List</h2>

        <table id="productsTable" class="table table-striped table-bordered table-hover" style="width:100%">
            <thead class="table-dark">
                <tr>
                    <th>Image</th>
                    <th>Title</th>
                    <th>Description</th>
                    <th>Price</th>
                    <th>Quantity</th>
                    <th>Category</th>
                    <% if (user && user.role==='admin' ) { %>
                        <th>Actions</th>
                        <% } %>
                </tr>
            </thead>
        </table>
    </div>

    <script>
        $(document).ready(function () {
            $('#productsTable').DataTable({
                select: true,
                pagingType: "full_numbers",
                processing: true,
                serverSide: true,
                ajax: function (data, callback) {
                    $.ajax({
                        url: '/products/all',
                        type: 'GET',
                        data: {
                            page: Math.floor(data.start / data.length) + 1,
                            limit: data.length,
                            search: data.search.value,
                            order: data.order.length ? data.columns[data.order[0].column].data + ':' + data.order[0].dir : null
                        },
                        dataType: 'json',
                        success: function (res) {
                            callback({
                                draw: data.draw,
                                recordsTotal: res.meta.totalItems,
                                recordsFiltered: res.meta.totalItems,
                                data: res.data
                            });
                        },
                        error: function (error) {
                            console.error("Server error:", error);

                            alert("Failed to load table data. Please try again.");
                        }
                    });
                },
                columnDefs: [
                    {
                        targets: '_all',
                        className: 'text-center', 
                        defaultContent: '-'
                    }
                ],
                columns: [
                    {
                        data: "image_url",
                        orderable: false,
                        render: function (data) {
                            return `<img src="/images/${data}" alt="Product" style="height:50px;">`;
                        },
                    },
                    { data: "title" },
                    { data: "description" },
                    { data: "price" },
                    { data: "quantity" },
                    { data: "category.name" },
                    {
                        data: "id",
                        orderable: false,
                        render: function (id) {
                            return `
                                <a href="/products/${id}" class="btn btn-sm btn-primary">Edit</a>
                                <form action="/products/${id}?_method=DELETE" method="POST" style="display:inline" 
                                    onsubmit="return confirm('Are you sure you want to delete this product?');">
                                        <button class="btn btn-sm btn-danger">Delete</button>
                                </form>
                            `;
                        }
                    }
                ]
            });
        });
    </script>

    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script> <!-- datatable -->
    <script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>
    <!-- datatable with bootstrap -->

</body>

</html>